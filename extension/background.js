chrome.runtime.onInstalled.addListener(() => {
  chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
    if (tabs[0] && tabs[0].url) {
      chrome.tabs.sendMessage(tabs[0].id, { type: 'checkUrl', url: tabs[0].url });
    }
  });
});

// Listen for tab updates and check the URL
chrome.tabs.onUpdated.addListener((tabId, changeInfo, tab) => {
  if (changeInfo.status === 'complete' && tab.url) {
    checkUrl(tab.url);
  }
});

// Function to check the URL by sending a request to the Flask API
async function checkUrl(url) {
  try {
    const response = await fetch('http://localhost:7000/api/predict', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ url: url })
    });

    const data = await response.json();

    if (data.result === 'malicious') {
      showPopup(url, 'malicious');
    } else if (data.result === 'benign') {
      showPopup(url, 'benign');
    }
  } catch (error) {
    console.error('Error:', error);
  }
}

// Function to show a popup notification
function showPopup(url, status) {
  let notificationOptions;

  if (status === 'malicious') {
    notificationOptions = {
      type: 'basic',
      iconUrl: 'icon.png',
      title: 'Malicious URL Detected',
      message: `The URL ${url} has been flagged as potentially phishing. Learn more about phishing attacks and how to protect yourself:`,
      buttons: [{ title: 'Ignore' }],
      priority: 0
    };
  } else {
    notificationOptions = {
      type: 'basic',
      iconUrl: 'icon.png',
      title: 'Safe URL Detected',
      message: `The URL ${url} is detected as safe. However, always stay cautious and informed about safe browsing practices.`,
      buttons: [{ title: 'Ignore' }],
      priority: 0
    };
  }

  chrome.notifications.create(notificationOptions, (notificationId) => {
    chrome.notifications.onButtonClicked.addListener((notifId, btnIdx) => {
      if (notifId === notificationId && btnIdx === 0) {
        if (status === 'malicious') {
          alert("Warning: Malicious website detected!!");
        } else {
          alert("Website is SAFE");
        }
      }
    });
  });
}
// These codes where gotten from philomathic, source -- https://github.com/philomathic-guy/Malicious-Web-Content-Detection-Using-Machine-Learning/blob/master/features_extraction.py
